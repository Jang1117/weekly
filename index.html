<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ì£¼ê°„ ì¼ì •í‘œ (v3)</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    :root{
      --header-main-h: 56px; /* ìš”ì¼ í—¤ë” ë†’ì´(2ì¤„) */
      --header-sub-h: 32px;  /* ì•„í˜„/í•˜ìŠ¹ í—¤ë” ë†’ì´ */
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }

    h1 {
      text-align: center;
      color: #333;
      margin-bottom: 20px;
      font-size: 2em;
    }

    .instructions {
      text-align: center;
      color: #666;
      margin-bottom: 20px;
      font-size: 14px;
      line-height: 1.5;
    }

    .schedule-wrapper {
      overflow-x: auto;
      overflow-y: auto;
      max-height: 70vh;
    }

    /* âœ… 7ì¼ ì»¬ëŸ¼ + ê° ìš”ì¼ ì•ˆì—ì„œ ì•„í˜„/í•˜ìŠ¹ 2ë¶„í•  */
    .schedule-grid {
      display: grid;
      grid-template-columns: 70px repeat(7, 1fr);
      min-width: 980px;
      position: relative;
    }

    /* âœ… 1í–‰(ìš”ì¼) í—¤ë” */
    .header-main {
      background: #667eea;
      color: white;
      padding: 6px 10px;
      text-align: center;
      font-weight: bold;
      position: sticky;
      top: 0;
      z-index: 1000;
      border: 1px solid #5568d3;
      user-select: none;
      height: var(--header-main-h);
      display: flex;
      flex-direction: column;
      justify-content: center;
      gap: 2px;
    }

    .header-date {
      font-size: 12px;
      font-weight: normal;
      opacity: 0.9;
    }

    .header-main[data-day] {
      cursor: pointer;
      transition: background 0.2s;
    }
    .header-main[data-day]:hover { background: #5568d3; }

    /* âœ… 2í–‰(ì•„í˜„/í•˜ìŠ¹) í—¤ë”: í•œ ì¹¸ ì•ˆì—ì„œ flex 2ë¶„í•  */
    .header-sub {
      /* âœ… ì•„ë˜ 2ì¹¸ì„ ê°ê° ìƒ‰ìœ¼ë¡œ ê½‰ ì±„ìš°ê¸° ìœ„í•´ ì»¨í…Œì´ë„ˆëŠ” íˆ¬ëª… + íŒ¨ë”© 0 */
      background: transparent;
      color: white;
      padding: 0;
      text-align: center;
      font-weight: 700;
      font-size: 12px;
      position: sticky;
      top: var(--header-main-h);
      border: 1px solid #4a5fc7;
      user-select: none;
      display: flex;
      gap: 0;
      height: var(--header-sub-h);
      overflow: hidden;
    }
    .header-sub > div {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      padding: 0;
    }
    .header-sub .sub-ahyun { background: #e91e63; }
    .header-sub .sub-haseung { background: #2196f3; }

    .time-slot {
      background: #f8f9fa;
      padding: 4px 5px;
      text-align: center;
      font-size: 12px;
      font-weight: 500;
      color: #555;
      border: 1px solid #e0e0e0;
      position: sticky;
      left: 0;
      z-index: 998;
      display: flex;
      align-items: flex-start;
      justify-content: center;
      user-select: none;
      height: 40px;
    }

    /* âœ… í•˜ë£¨(ìš”ì¼) í•œ ì¹¸: ë‚´ë¶€ì— 2ê°œì˜ schedule-cell */
    .day-group {
      position: relative;
      height: 40px;
      display: flex;
      overflow: visible; /* ì´ë²¤íŠ¸ê°€ ì•„ë˜ë¡œ ê¸¸ì–´ì§ˆ ë•Œ ì˜ë¦¬ì§€ ì•Šê²Œ */
      background: #fff;
    }

    .schedule-cell {
      flex: 1;
      background: white;
      border: 1px solid #e0e0e0;
      position: relative;
      cursor: crosshair;
      transition: background 0.2s;
      overflow: visible;
    }
    /* ê°€ìš´ë° êµ¬ë¶„ì„  ì¤‘ë³µ ë°©ì§€ */
    .schedule-cell.left { border-right: 1px solid #e0e0e0; }
    .schedule-cell.right { border-left: none; }

    .schedule-cell:hover { background: #f0f7ff; }
    .schedule-cell.selecting { background: #d4e5ff; }
    .schedule-cell.drop-target {
      background: #fff3cd;
      border: 2px dashed #ffc107;
    }

    @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
    @keyframes slideDown { from { opacity: 0; transform: translateX(-50%) translateY(-20px); } to { opacity: 1; transform: translateX(-50%) translateY(0); } }
    @keyframes slideUp { from { opacity: 1; transform: translateX(-50%) translateY(0); } to { opacity: 0; transform: translateX(-50%) translateY(-20px); } }

    .event {
      position: absolute;
      left: 2px;
      right: 2px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 4px 6px;
      border-radius: 4px;
      font-size: 13px;
      cursor: move;
      overflow: hidden;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      z-index: 50; /* ì•„ë˜ í–‰ ì…€ë³´ë‹¤ ìœ„ */
    }
    .event:hover { box-shadow: 0 4px 8px rgba(0,0,0,0.3); }

    .event-title {
      font-weight: 600;
      margin-bottom: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .event-time { font-size: 11px; opacity: 0.9; }

    .event-delete, .event-edit {
      position: absolute;
      top: 2px;
      background: rgba(255,255,255,0.3);
      border: none;
      color: white;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      align-items: center;
      justify-content: center;
      line-height: 1;
      padding: 0;
      user-select: none;
    }
    .event-delete { right: 2px; font-size: 14px; }
    .event-edit { right: 24px; font-size: 12px; }
    .event:hover .event-delete,
    .event:hover .event-edit { display: flex; }

    .event-resize-handle {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 8px;
      cursor: ns-resize;
      background: rgba(255,255,255,0.2);
      opacity: 0;
    }
    .event:hover .event-resize-handle { opacity: 1; }

    .event.ahyun { background: linear-gradient(135deg, #f48fb1 0%, #e91e63 100%); }
    .event.haseung { background: linear-gradient(135deg, #64b5f6 0%, #2196f3 100%); }
    .event.common { background: linear-gradient(135deg, #81c784 0%, #4caf50 100%); }

    .controls {
      margin-top: 20px;
      text-align: center;
      display: flex;
      justify-content: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    button {
      background: #667eea;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s;
      user-select: none;
    }
    button:hover {
      background: #5568d3;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    .modal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    .modal.active { display: flex; }

    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 12px;
      width: 90%;
      max-width: 420px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    }
    .modal-content h2 { margin-bottom: 20px; color: #333; }

    .user-selector {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      justify-content: center;
    }
    .user-button {
      flex: 1;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 8px;
      background: white;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
    }
    .user-button.active { border-color: #667eea; transform: scale(1.05); }

    .user-button.ahyun { color: #e91e63; }
    .user-button.ahyun.active { background: #fce4ec; border-color: #e91e63; }

    .user-button.haseung { color: #2196f3; }
    .user-button.haseung.active { background: #e3f2fd; border-color: #2196f3; }

    .user-button.common { color: #4caf50; }
    .user-button.common.active { background: #e8f5e9; border-color: #4caf50; }

    .form-group { margin-bottom: 15px; }
    .form-group label {
      display: block;
      margin-bottom: 5px;
      color: #555;
      font-weight: 500;
    }
    .form-group input, .form-group textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-family: inherit;
      font-size: 14px;
    }
    .form-group textarea { resize: vertical; min-height: 60px; }

    .modal-buttons {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
    .modal-buttons button { flex: 1; }

    .btn-cancel { background: #6c757d; }
    .btn-cancel:hover { background: #5a6268; }

    /* ì¸ì‡„ ì„¤ì • ëª¨ë‹¬ */
    .print-modal-content { max-width: 520px; }
    .time-range-selector {
      display: flex;
      gap: 15px;
      align-items: center;
      justify-content: center;
      margin: 20px 0;
    }
    .time-range-selector select {
      padding: 10px 15px;
      border: 2px solid #667eea;
      border-radius: 8px;
      font-size: 16px;
      background: white;
      cursor: pointer;
    }
    .time-range-selector span {
      font-size: 18px;
      color: #333;
      font-weight: 500;
    }
    .print-preview-info {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
      text-align: center;
      color: #555;
    }
    .orientation-selector {
      display: flex;
      gap: 10px;
      justify-content: center;
    }
    .orientation-btn {
      flex: 1;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 8px;
      background: white;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.3s;
      color: #333;
    }
    .orientation-btn:hover { border-color: #667eea; transform: none; box-shadow: none; }
    .orientation-btn.active {
      background: #e8eeff;
      border-color: #667eea;
      color: #667eea;
    }

    .date-preview {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      font-size: 14px;
      color: #555;
    }
    .date-preview div { padding: 5px; }
    .date-preview span { font-weight: 600; color: #667eea; }

    /* ë¡œë”© ì˜¤ë²„ë ˆì´ */
    .loading-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(255,255,255,0.9);
      z-index: 2000;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }
    .loading-overlay.active { display: flex; }

    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 5px solid #f3f3f3;
      border-top: 5px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    .loading-text {
      margin-top: 20px;
      font-size: 16px;
      color: #333;
    }

    @media print {
      body { background: white; padding: 0; margin: 0; }
      .container { display: none; }
      .controls { display: none; }
      .modal { display: none !important; }
      .loading-overlay { display: none !important; }

      #printContainer {
        display: flex !important;
        justify-content: center;
        align-items: center;
        width: 100%;
        height: 100vh;
        page-break-inside: avoid;
      }
      #printContainer img {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
      }
      @page { margin: 3mm; }
    }

    #printContainer { display: none; }
  
    /* âœ… v6: ì„œë¸Œí—¤ë”(ì•„í˜„/í•˜ìŠ¹)ë„ ìŠ¤í¬ë¡¤ ì‹œ ë°˜ë“œì‹œ ê³ ì • */
    .header-main{ position: sticky !important; top: 0 !important; z-index: 1000 !important; }
    .header-sub{ position: sticky !important; top: var(--header-main-h) !important; z-index: 999 !important; }


    /* âœ… v7: ì™¼ìª½ 'ì‹œê°„' í—¤ë”ëŠ” 2ì¤„(ìš”ì¼+ì•„í˜„/í•˜ìŠ¹) ë†’ì´ë¥¼ ëª¨ë‘ ë®ë„ë¡ */
    .time-header{
      height: calc(var(--header-main-h) + var(--header-sub-h));
      justify-content: center;
      padding: 0 10px;
      z-index: 1001; /* ë‹¤ë¥¸ í—¤ë”ë³´ë‹¤ ìœ„ */
    }


    /* âœ… v10: ìš”ì¼ë³„ êµ¬ë¶„ì„ (êµµì€ ì„ ) */
    .header-main[data-day]:not([data-day="6"]) {
      border-right: 4px solid rgba(0,0,0,0.25);
    }

    /* header-subëŠ” ìš”ì¼ë³„ 1ê°œì”©ì´ë©° ë§ˆì§€ë§‰(ì¼ìš”ì¼)ë§Œ ì˜ˆì™¸ ì²˜ë¦¬ */
    .header-sub { border-right: 4px solid rgba(0,0,0,0.18); }
    .header-sub[style*="grid-column: 8"] { border-right: 1px solid #4a5fc7; } /* ì¼ìš”ì¼ì€ ê¸°ë³¸ì„  */

    /* ë³¸ë¬¸: ìš”ì¼ ê·¸ë£¹ ì˜¤ë¥¸ìª½ì— êµµì€ ì„  */
    .day-group { border-right: 4px solid rgba(0,0,0,0.15); }
    .day-group[data-day="6"] { border-right: none; }

    /* ë‚´ë¶€ ì…€ì˜ ì˜¤ë¥¸ìª½ í…Œë‘ë¦¬ë¥¼ ì—†ì• ê³  day-groupì˜ êµµì€ ì„ ì´ ë³´ì´ê²Œ */
    .schedule-cell.right { border-right: none; }

</style>
</head>

<body>
  <div class="container">
    <h1>ğŸ“… ì£¼ê°„ ì¼ì •í‘œ</h1>
    <div class="instructions">
      ğŸ’¡ ë“œë˜ê·¸í•˜ì—¬ ì¼ì • ìƒì„±(ê°™ì€ ìš”ì¼ì˜ ê°™ì€ ì‚¬ëŒ ì¹¼ëŸ¼ì—ì„œë§Œ ì„¸ë¡œ ë“œë˜ê·¸)<br>
      âœï¸ ë²„íŠ¼ìœ¼ë¡œ ìˆ˜ì • | ë“œë˜ê·¸ë¡œ ì´ë™ | Ctrl+í´ë¦­(ë˜ëŠ” Ctrl+V)ìœ¼ë¡œ ë³µì‚¬/ë¶™ì—¬ë„£ê¸° | í•˜ë‹¨ ë“œë˜ê·¸ë¡œ í¬ê¸° ì¡°ì ˆ<br>
      âœ… ê°œì¸ ì¼ì •ì€ ì•„í˜„/í•˜ìŠ¹ ì¹¸ì— ë”°ë¡œ í‘œì‹œ, <b>ê³µí†µì€ 2ì¹¸ì„ ê°€ë¡œë¡œ spaní•´ì„œ í•œ ë²ˆë§Œ í‘œì‹œ</b>
    </div>

    <div class="schedule-wrapper" id="scheduleWrapper">
      <div class="schedule-grid" id="scheduleGrid">
        <!-- 2ì¤„ í—¤ë” -->
        <div class="header-main time-header" style="grid-column: 1; grid-row: 1 / span 2;">ì‹œê°„</div>

        <div class="header-main" data-day="0" style="grid-column: 2; grid-row: 1;">ì›”ìš”ì¼<br><span class="header-date" id="date-0">(1/6)</span></div>
        <div class="header-main" data-day="1" style="grid-column: 3; grid-row: 1;">í™”ìš”ì¼<br><span class="header-date" id="date-1">(1/7)</span></div>
        <div class="header-main" data-day="2" style="grid-column: 4; grid-row: 1;">ìˆ˜ìš”ì¼<br><span class="header-date" id="date-2">(1/8)</span></div>
        <div class="header-main" data-day="3" style="grid-column: 5; grid-row: 1;">ëª©ìš”ì¼<br><span class="header-date" id="date-3">(1/9)</span></div>
        <div class="header-main" data-day="4" style="grid-column: 6; grid-row: 1;">ê¸ˆìš”ì¼<br><span class="header-date" id="date-4">(1/10)</span></div>
        <div class="header-main" data-day="5" style="grid-column: 7; grid-row: 1;">í† ìš”ì¼<br><span class="header-date" id="date-5">(1/11)</span></div>
        <div class="header-main" data-day="6" style="grid-column: 8; grid-row: 1;">ì¼ìš”ì¼<br><span class="header-date" id="date-6">(1/12)</span></div>

        <div class="header-sub" style="grid-column: 2; grid-row: 2;">
          <div class="sub-ahyun">ğŸ‘© ì•„í˜„</div><div class="sub-haseung">ğŸ‘¨ í•˜ìŠ¹</div>
        </div>
        <div class="header-sub" style="grid-column: 3; grid-row: 2;">
          <div class="sub-ahyun">ğŸ‘© ì•„í˜„</div><div class="sub-haseung">ğŸ‘¨ í•˜ìŠ¹</div>
        </div>
        <div class="header-sub" style="grid-column: 4; grid-row: 2;">
          <div class="sub-ahyun">ğŸ‘© ì•„í˜„</div><div class="sub-haseung">ğŸ‘¨ í•˜ìŠ¹</div>
        </div>
        <div class="header-sub" style="grid-column: 5; grid-row: 2;">
          <div class="sub-ahyun">ğŸ‘© ì•„í˜„</div><div class="sub-haseung">ğŸ‘¨ í•˜ìŠ¹</div>
        </div>
        <div class="header-sub" style="grid-column: 6; grid-row: 2;">
          <div class="sub-ahyun">ğŸ‘© ì•„í˜„</div><div class="sub-haseung">ğŸ‘¨ í•˜ìŠ¹</div>
        </div>
        <div class="header-sub" style="grid-column: 7; grid-row: 2;">
          <div class="sub-ahyun">ğŸ‘© ì•„í˜„</div><div class="sub-haseung">ğŸ‘¨ í•˜ìŠ¹</div>
        </div>
        <div class="header-sub" style="grid-column: 8; grid-row: 2;">
          <div class="sub-ahyun">ğŸ‘© ì•„í˜„</div><div class="sub-haseung">ğŸ‘¨ í•˜ìŠ¹</div>
        </div>
      </div>
    </div>

    <div class="controls">
      <button onclick="openDateModal()">ğŸ“… ë‚ ì§œ ì„¤ì •</button>
      <button onclick="openPrintModal()">ğŸ–¨ï¸ A4 ì¸ì‡„</button>
      <button onclick="clearAllEvents()">ì „ì²´ ì§€ìš°ê¸°</button>
      <button onclick="exportSchedule()">ë‚´ë³´ë‚´ê¸°</button>
      <button onclick="importSchedule()">ê°€ì ¸ì˜¤ê¸°</button>
    </div>
  </div>

  <div id="printContainer"></div>

  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner"></div>
    <div class="loading-text">ì¸ì‡„ ì¤€ë¹„ ì¤‘...</div>
  </div>

  <!-- ì¼ì • ìƒì„±/ìˆ˜ì • ëª¨ë‹¬ -->
  <div class="modal" id="eventModal">
    <div class="modal-content">
      <h2 id="modalTitle">ìƒˆ ì¼ì •</h2>
      <div class="user-selector">
        <button type="button" class="user-button ahyun active" onclick="selectUser('ahyun')">ğŸ‘© ì•„í˜„</button>
        <button type="button" class="user-button haseung" onclick="selectUser('haseung')">ğŸ‘¨ í•˜ìŠ¹</button>
        <button type="button" class="user-button common" onclick="selectUser('common')">ğŸ‘¥ ê³µí†µ</button>
      </div>
      <div class="form-group">
        <label>ì¼ì • ì œëª©</label>
        <input type="text" id="eventTitle" placeholder="ì¼ì • ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" />
      </div>
      <div class="form-group">
        <label>ì„¤ëª… (ì„ íƒ)</label>
        <textarea id="eventDescription" placeholder="ìƒì„¸ ì„¤ëª…"></textarea>
      </div>
      <div class="form-group">
        <label>í‘œì‹œ ì‹œì‘/ì¢…ë£Œ ì‹œê°„ (ì˜ì—­ì€ ê·¸ëŒ€ë¡œ, í‘œê¸°ë§Œ ë³€ê²½)</label>
        <div style="display:flex; gap:10px;">
          <input type="time" id="displayStartTime" step="60" style="flex:1;" />
          <input type="time" id="displayEndTime" step="60" style="flex:1;" />
        </div>
        <div style="margin-top:6px; font-size:12px; color:#777;">
          ì˜ˆ: 12:10ì²˜ëŸ¼ ë¶„ ë‹¨ìœ„ ì…ë ¥ ê°€ëŠ¥ (ë¸”ë¡ ìœ„ì¹˜/í¬ê¸°ëŠ” 30ë¶„ ë‹¨ìœ„ ìœ ì§€)
        </div>
      </div>

      <div class="modal-buttons">
        <button class="btn-cancel" onclick="closeModal()">ì·¨ì†Œ</button>
        <button onclick="saveEvent()">ì €ì¥</button>
      </div>
    </div>
  </div>

  <!-- ì¸ì‡„ ì„¤ì • ëª¨ë‹¬ -->
  <div class="modal" id="printModal">
    <div class="modal-content print-modal-content">
      <h2>ğŸ–¨ï¸ ì¸ì‡„ ì„¤ì •</h2>
      <p style="text-align:center;color:#666;margin-bottom:15px;">ì¸ì‡„í•  ì‹œê°„ëŒ€ë¥¼ ì„ íƒí•˜ì„¸ìš”</p>

      <div class="time-range-selector">
        <select id="printStartTime"></select>
        <span>~</span>
        <select id="printEndTime"></select>
      </div>

      <div class="print-preview-info" id="printPreviewInfo">ì„ íƒëœ ì‹œê°„ëŒ€: 09:00 ~ 21:00</div>

      <div style="margin: 20px 0;">
        <label style="display:block;margin-bottom:10px;color:#555;font-weight:500;text-align:center;">ìš©ì§€ ë°©í–¥</label>
        <div class="orientation-selector">
          <button type="button" class="orientation-btn active" data-orientation="portrait" onclick="selectOrientation('portrait')">ğŸ“„ ì„¸ë¡œ</button>
          <button type="button" class="orientation-btn" data-orientation="landscape" onclick="selectOrientation('landscape')">ğŸ“ƒ ê°€ë¡œ</button>
        </div>
      </div>

      <div class="modal-buttons">
        <button class="btn-cancel" onclick="closePrintModal()">ì·¨ì†Œ</button>
        <button onclick="executePrint()">ì¸ì‡„í•˜ê¸°</button>
      </div>
    </div>
  </div>

  <!-- ë‚ ì§œ ì„¤ì • ëª¨ë‹¬ -->
  <div class="modal" id="dateModal">
    <div class="modal-content">
      <h2>ğŸ“… ë‚ ì§œ ì„¤ì •</h2>
      <p style="text-align:center;color:#666;margin-bottom:15px;">ì›”ìš”ì¼ ë‚ ì§œë¥¼ ì„ íƒí•˜ë©´ ë‚˜ë¨¸ì§€ ìš”ì¼ì´ ìë™ ê³„ì‚°ë©ë‹ˆë‹¤</p>

      <div class="form-group">
        <label>ì›”ìš”ì¼ ë‚ ì§œ</label>
        <input type="date" id="mondayDate" />
      </div>

      <div class="date-preview" id="datePreview">
        <div>ì›”ìš”ì¼: <span id="preview-0">1/6</span></div>
        <div>í™”ìš”ì¼: <span id="preview-1">1/7</span></div>
        <div>ìˆ˜ìš”ì¼: <span id="preview-2">1/8</span></div>
        <div>ëª©ìš”ì¼: <span id="preview-3">1/9</span></div>
        <div>ê¸ˆìš”ì¼: <span id="preview-4">1/10</span></div>
        <div>í† ìš”ì¼: <span id="preview-5">1/11</span></div>
        <div>ì¼ìš”ì¼: <span id="preview-6">1/12</span></div>
      </div>

      <div class="modal-buttons">
        <button class="btn-cancel" onclick="closeDateModal()">ì·¨ì†Œ</button>
        <button onclick="saveDates()">ì €ì¥</button>
      </div>
    </div>
  </div>

  <script>
    // ì‹œê°„ëŒ€ ìƒì„± (9:00 ~ 21:00, 30ë¶„ ê°„ê²©)
    const times = [];
    for (let h = 9; h <= 21; h++) {
      times.push(`${String(h).padStart(2, '0')}:00`);
      if (h < 21) times.push(`${String(h).padStart(2, '0')}:30`);
    }

    const days = ['ì›”ìš”ì¼','í™”ìš”ì¼','ìˆ˜ìš”ì¼','ëª©ìš”ì¼','ê¸ˆìš”ì¼','í† ìš”ì¼','ì¼ìš”ì¼'];
    const grid = document.getElementById('scheduleGrid');

    // âœ… ê·¸ë¦¬ë“œ ìƒì„±: ê° ì‹œê°„í–‰ì— (ì‹œê°„ì¹¸ 1) + (ìš”ì¼ 7: ê° ìš”ì¼ì€ ë‚´ë¶€ 2ë¶„í• )
    times.forEach((time, timeIndex) => {
      const timeSlot = document.createElement('div');
      timeSlot.className = 'time-slot';
      timeSlot.textContent = time;
      timeSlot.dataset.row = timeIndex;
      grid.appendChild(timeSlot);

      days.forEach((_, dayIndex) => {
        const group = document.createElement('div');
        group.className = 'day-group';
        group.dataset.day = dayIndex;
        group.dataset.time = timeIndex;
        group.dataset.row = timeIndex;

        const left = document.createElement('div');
        left.className = 'schedule-cell left';
        left.dataset.day = dayIndex;
        left.dataset.time = timeIndex;
        left.dataset.user = 'ahyun';

        const right = document.createElement('div');
        right.className = 'schedule-cell right';
        right.dataset.day = dayIndex;
        right.dataset.time = timeIndex;
        right.dataset.user = 'haseung';

        group.appendChild(left);
        group.appendChild(right);
        grid.appendChild(group);
      });
    });

    // ì „ì—­ ë³€ìˆ˜
    let events = JSON.parse(localStorage.getItem('weeklyEvents') || '[]');
    let isDragging = false;
    let dragStart = null;
    let dragEnd = null;
    let currentEvent = null;

    let isResizing = false;
    let resizingEvent = null;

    let isDraggingEvent = false;
    let draggedEventIndex = null;

    let copiedEvent = null;
    let selectedUser = 'ahyun';

    let selectedOrientation = 'portrait';
    // âœ… v8: í‘œì‹œìš© ì‹œê°„(ë¶„ ë‹¨ìœ„) ì§€ì› - ë¸”ë¡(ì˜ì—­)ì€ ê·¸ëŒ€ë¡œ ë‘ê³  ë¼ë²¨ë§Œ ë³€ê²½
    function formatHHMM(value){
      // value: 'HH:MM' -> keep as-is
      return value;
    }
    function defaultDisplayTimesFor(event){
      const start = times[event.startTime];
      const endIndex = Math.min(event.endTime + 1, times.length - 1);
      const end = times[endIndex];
      return { start, end };
    }
    function setDisplayInputs(startStr, endStr){
      const s = document.getElementById('displayStartTime');
      const e = document.getElementById('displayEndTime');
      if (s) s.value = startStr || '';
      if (e) e.value = endStr || '';
    }

    let weekDates = JSON.parse(localStorage.getItem('weekDates') || 'null');

    // ìš©ì§€ ë°©í–¥ ì„ íƒ
    function selectOrientation(orientation) {
      selectedOrientation = orientation;
      document.querySelectorAll('.orientation-btn').forEach(btn => btn.classList.remove('active'));
      document.querySelector(`.orientation-btn[data-orientation="${orientation}"]`).classList.add('active');
    }

    // ë‚ ì§œ ì„¤ì • ëª¨ë‹¬
    function openDateModal() {
      document.getElementById('dateModal').classList.add('active');
      if (weekDates) {
        document.getElementById('mondayDate').value = weekDates.monday;
        updateDatePreview();
      } else {
        document.getElementById('mondayDate').value = getNextMonday();
        updateDatePreview();
      }
    }

    function getNextMonday() {
      const today = new Date();
      const day = today.getDay(); // 0=ì¼, 1=ì›”
      let daysUntilMonday;
      if (day === 0) daysUntilMonday = 1;
      else if (day === 1) daysUntilMonday = 0;
      else daysUntilMonday = 8 - day;

      const nextMonday = new Date(today);
      nextMonday.setDate(today.getDate() + daysUntilMonday);
      return nextMonday.toISOString().split('T')[0];
    }

    function closeDateModal() {
      document.getElementById('dateModal').classList.remove('active');
    }

    function updateDatePreview() {
      const mondayInput = document.getElementById('mondayDate').value;
      if (!mondayInput) return;

      const monday = new Date(mondayInput);
      for (let i = 0; i < 7; i++) {
        const date = new Date(monday);
        date.setDate(monday.getDate() + i);
        document.getElementById(`preview-${i}`).textContent = `${date.getMonth()+1}/${date.getDate()}`;
      }
    }

    function saveDates() {
      const mondayInput = document.getElementById('mondayDate').value;
      if (!mondayInput) { alert('ì›”ìš”ì¼ ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”'); return; }

      const monday = new Date(mondayInput);
      weekDates = { monday: mondayInput };

      for (let i = 0; i < 7; i++) {
        const date = new Date(monday);
        date.setDate(monday.getDate() + i);
        document.getElementById(`date-${i}`).textContent = `(${date.getMonth()+1}/${date.getDate()})`;
      }

      localStorage.setItem('weekDates', JSON.stringify(weekDates));
      closeDateModal();
    }

    function loadSavedDates() {
      const mondayStr = (weekDates && weekDates.monday) ? weekDates.monday : getNextMonday();
      const monday = new Date(mondayStr);

      for (let i = 0; i < 7; i++) {
        const date = new Date(monday);
        date.setDate(monday.getDate() + i);
        document.getElementById(`date-${i}`).textContent = `(${date.getMonth()+1}/${date.getDate()})`;
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('mondayDate').addEventListener('change', updateDatePreview);
      loadSavedDates();
    });

    // ì¸ì‡„ ì„¤ì • ëª¨ë‹¬ ì´ˆê¸°í™”
    function initPrintModal() {
      const startSelect = document.getElementById('printStartTime');
      const endSelect = document.getElementById('printEndTime');

      times.forEach((time, index) => {
        const startOption = document.createElement('option');
        startOption.value = index;
        startOption.textContent = time;
        startSelect.appendChild(startOption);

        const endOption = document.createElement('option');
        endOption.value = index;
        endOption.textContent = time;
        endSelect.appendChild(endOption);
      });

      startSelect.value = 0;
      endSelect.value = times.length - 1;

      startSelect.addEventListener('change', updatePrintPreview);
      endSelect.addEventListener('change', updatePrintPreview);
    }

    
    // âœ… v9: í”„ë¦°íŠ¸ ê¸°ë³¸ ì‹œê°„ëŒ€ ìë™ ì„¤ì •
    // - ì¼ì • ì¤‘ ê°€ì¥ ëŠ¦ì€ ì¢…ë£Œ ìŠ¬ë¡¯(endTime)ì„ ì°¾ê³ , ê·¸ +30ë¶„(= +1 ìŠ¬ë¡¯)ê¹Œì§€ë§Œ ê¸°ë³¸ ì¢…ë£Œì‹œê°„ìœ¼ë¡œ ì„¤ì •
    function getAutoPrintEndIndex() {
      if (!Array.isArray(events) || events.length === 0) return times.length - 1;

      let maxEnd = 0;
      events.forEach(ev => {
        if (typeof ev?.endTime === 'number') maxEnd = Math.max(maxEnd, ev.endTime);
      });

      // endTimeì€ "ë§ˆì§€ë§‰ ì¹¸" ì¸ë±ìŠ¤ì´ë¯€ë¡œ, í‘œì‹œ ì¢…ë£ŒëŠ” +1 ìŠ¬ë¡¯ì´ ì¼ë°˜ì 
      // ìš”êµ¬ì‚¬í•­: "ê°€ì¥ ëŠ¦ì€ ì‹œê°„ì„ ê¸°ì¤€ìœ¼ë¡œ +30ë¶„" => ì¢…ë£Œ ì¸ë±ìŠ¤ë¥¼ (maxEnd + 1)ë¡œ
      return Math.min(maxEnd + 1, times.length - 1);
    }

    function applyAutoPrintDefaults() {
      const startSelect = document.getElementById('printStartTime');
      const endSelect = document.getElementById('printEndTime');
      if (!startSelect || !endSelect) return;

      // ì‹œì‘ì€ ê¸°ì¡´ëŒ€ë¡œ 09:00(0) ìœ ì§€, ì¢…ë£Œë§Œ ìë™ ì¡°ì •
      startSelect.value = 0;
      endSelect.value = String(getAutoPrintEndIndex());
      updatePrintPreview();
    }

    // âœ… v9: PDF ì €ì¥ ì‹œ ê¸°ë³¸ íŒŒì¼ëª…(ë¸Œë¼ìš°ì €ë³„ ë™ì‘ ì°¨ì´ ìˆìŒ)
    function getWeekStartYMD() {
      const mondayStr = (weekDates && weekDates.monday) ? weekDates.monday : getNextMonday();
      const d = new Date(mondayStr);
      const yyyy = String(d.getFullYear());
      const mm = String(d.getMonth() + 1).padStart(2, '0');
      const dd = String(d.getDate()).padStart(2, '0');
      return `${yyyy}${mm}${dd}`;
    }

function updatePrintPreview() {
      const startIndex = parseInt(document.getElementById('printStartTime').value);
      const endIndex = parseInt(document.getElementById('printEndTime').value);
      const info = document.getElementById('printPreviewInfo');

      if (startIndex > endIndex) {
        info.textContent = 'âš ï¸ ì‹œì‘ ì‹œê°„ì´ ì¢…ë£Œ ì‹œê°„ë³´ë‹¤ ëŠ¦ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤';
        info.style.color = '#dc3545';
      } else {
        const rowCount = endIndex - startIndex + 1;
        info.textContent = `ì„ íƒëœ ì‹œê°„ëŒ€: ${times[startIndex]} ~ ${times[endIndex]} (${rowCount}ê°œ í–‰)`;
        info.style.color = '#555';
      }
    }

    function openPrintModal() {
      document.getElementById('printModal').classList.add('active');
      applyAutoPrintDefaults();
    }
    function closePrintModal() {
      document.getElementById('printModal').classList.remove('active');
    }

    async function executePrint() {
      const startIndex = parseInt(document.getElementById('printStartTime').value);
      const endIndex = parseInt(document.getElementById('printEndTime').value);

      if (startIndex > endIndex) { alert('ì‹œì‘ ì‹œê°„ì´ ì¢…ë£Œ ì‹œê°„ë³´ë‹¤ ëŠ¦ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return; }

      closePrintModal();
      document.getElementById('loadingOverlay').classList.add('active');

      try {
        // ì„ íƒë˜ì§€ ì•Šì€ í–‰ ìˆ¨ê¸°ê¸° (time-slot + day-group)
        const allRows = document.querySelectorAll('[data-row]');
        allRows.forEach(el => {
          const rowIndex = parseInt(el.dataset.row);
          if (rowIndex < startIndex || rowIndex > endIndex) el.style.display = 'none';
        });

        const wrapper = document.getElementById('scheduleWrapper');
        const originalScroll = wrapper.scrollTop;
        wrapper.scrollTop = 0;

        await new Promise(resolve => setTimeout(resolve, 120));

        const canvas = await html2canvas(document.getElementById('scheduleGrid'), {
          scale: 2,
          useCORS: true,
          logging: false,
          backgroundColor: '#ffffff'
        });

        // ë³µì›
        allRows.forEach(el => el.style.display = '');
        wrapper.scrollTop = originalScroll;

        const printContainer = document.getElementById('printContainer');
        printContainer.innerHTML = '';

        const img = document.createElement('img');
        img.src = canvas.toDataURL('image/png');
        img.style.width = '100%';
        printContainer.appendChild(img);

        let printStyle = document.getElementById('printPageStyle');
        if (printStyle) printStyle.remove();
        printStyle = document.createElement('style');
        printStyle.id = 'printPageStyle';
        printStyle.textContent = `@media print { @page { size: A4 ${selectedOrientation}; margin: 3mm; } }`;
        document.head.appendChild(printStyle);

        document.getElementById('loadingOverlay').classList.remove('active');

        // âœ… v9: PDF ì €ì¥ ì‹œ ê¸°ë³¸ íŒŒì¼ëª… ì„¤ì • (Chrome ë“±ì—ì„œ document.titleì„ ì‚¬ìš©)
        const originalTitle = document.title;
        const ymd = getWeekStartYMD();
        document.title = `ì£¼ê°„ì¼ì •í‘œ_${ymd}`;

        const restoreTitle = () => {
          document.title = originalTitle;
          window.removeEventListener('afterprint', restoreTitle);
        };
        window.addEventListener('afterprint', restoreTitle);

        setTimeout(() => window.print(), 100);

      } catch (error) {
        console.error('ì¸ì‡„ ì¤€ë¹„ ì¤‘ ì˜¤ë¥˜:', error);
        document.getElementById('loadingOverlay').classList.remove('active');
        alert('ì¸ì‡„ ì¤€ë¹„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        document.querySelectorAll('[data-row]').forEach(el => el.style.display = '');
      }
    }

    // âœ… ì´ë²¤íŠ¸ ë Œë”ë§
    function renderEvents() {
      document.querySelectorAll('.event').forEach(e => e.remove());

      events.forEach((event, index) => {
        const duration = event.endTime - event.startTime + 1;
        const cellHeight = 40;

        const endTimeIndex = Math.min(event.endTime + 1, times.length - 1);
        const userIcon = (event.user === 'ahyun') ? 'ğŸ‘© ' : (event.user === 'haseung') ? 'ğŸ‘¨ ' : 'ğŸ‘¥ ';

        const eventEl = document.createElement('div');
        eventEl.className = `event ${event.user || 'ahyun'}`;
        eventEl.dataset.index = index;

        eventEl.style.top = '0px';
        eventEl.style.height = `${duration * cellHeight - 4}px`;

        eventEl.innerHTML = `
          <div class="event-title">${userIcon}${event.title}</div>
          <div class="event-time">${(event.displayStart || times[event.startTime])} - ${(event.displayEnd || times[endTimeIndex])}</div>
          <button class="event-edit" onclick="editEvent(${index})">âœï¸</button>
          <button class="event-delete" onclick="deleteEvent(${index})">Ã—</button>
          <div class="event-resize-handle"></div>
        `;

        let target;
        if (event.user === 'common') {
          // âœ… ê³µí†µ: day-group(ìš”ì¼ í•œ ì¹¸)ì— ë¶™ì—¬ì„œ 2ì¹¸ spanì²˜ëŸ¼ í•œ ë²ˆë§Œ í‘œì‹œ
          target = document.querySelector(`.day-group[data-day="${event.day}"][data-time="${event.startTime}"]`);
        } else {
          target = document.querySelector(
            `.schedule-cell[data-day="${event.day}"][data-time="${event.startTime}"][data-user="${event.user || 'ahyun'}"]`
          );
        }
        if (!target) return;

        target.appendChild(eventEl);

        // ì´ë™/ë³µì‚¬ í•¸ë“¤
        eventEl.addEventListener('mousedown', (e) => {
          if (e.button === 0 &&
              !e.target.classList.contains('event-delete') &&
              !e.target.classList.contains('event-edit') &&
              !e.target.classList.contains('event-resize-handle')) {

            e.preventDefault();
            e.stopPropagation();

            if (e.ctrlKey || e.metaKey) {
              copiedEvent = { ...event };
              eventEl.style.animation = 'pulse 0.3s';
              setTimeout(() => eventEl.style.animation = '', 300);
              showNotification('ì¼ì •ì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤. ë¹ˆ ì…€ì„ Ctrl+í´ë¦­(ë˜ëŠ” Ctrl+V)í•˜ì—¬ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.');
            } else {
              isDraggingEvent = true;
              draggedEventIndex = index;
              eventEl.style.opacity = '0.6';
              eventEl.style.zIndex = '2000';
            }
          }
        });

        // ë¦¬ì‚¬ì´ì¦ˆ í•¸ë“¤
        const resizeHandle = eventEl.querySelector('.event-resize-handle');
        resizeHandle.addEventListener('mousedown', (e) => {
          e.stopPropagation();
          isResizing = true;
          resizingEvent = index;
        });
      });
    }

    // âœ… ë“œë˜ê·¸ë¡œ ì¼ì • ìƒì„± / Ctrl+í´ë¦­ ë¶™ì—¬ë„£ê¸°
    grid.addEventListener('mousedown', (e) => {
      if (e.target.classList.contains('schedule-cell') && !isResizing) {
        // Ctrl+í´ë¦­ ë¶™ì—¬ë„£ê¸°
        if ((e.ctrlKey || e.metaKey) && copiedEvent) {
          e.preventDefault();

          const newDay = parseInt(e.target.dataset.day);
          const newTime = parseInt(e.target.dataset.time);
          const newUser = e.target.dataset.user;

          const duration = copiedEvent.endTime - copiedEvent.startTime;

          events.push({
            ...copiedEvent,
            day: newDay,
            startTime: newTime,
            endTime: Math.min(newTime + duration, times.length - 1),
            user: (copiedEvent.user === 'common') ? 'common' : newUser
          });

          saveToLocalStorage();
          renderEvents();
          showNotification('ì¼ì •ì´ ë¶™ì—¬ë„£ê¸° ë˜ì—ˆìŠµë‹ˆë‹¤.');
          return;
        }

        // ì¼ë°˜ ë“œë˜ê·¸ ìƒì„±
        isDragging = true;
        selectedUser = e.target.dataset.user;

        dragStart = {
          day: parseInt(e.target.dataset.day),
          time: parseInt(e.target.dataset.time),
          user: e.target.dataset.user
        };
        dragEnd = { ...dragStart };

        e.target.classList.add('selecting');
      }
    });

    grid.addEventListener('mousemove', (e) => {
      if (isDragging && e.target.classList.contains('schedule-cell')) {
        const newDay = parseInt(e.target.dataset.day);
        const newTime = parseInt(e.target.dataset.time);
        const newUser = e.target.dataset.user;

        // ê°™ì€ ìš”ì¼ + ê°™ì€ ìœ ì € ì¹¼ëŸ¼ì—ì„œë§Œ ì„¸ë¡œ ë“œë˜ê·¸
        if (newDay === dragStart.day && newUser === dragStart.user) {
          dragEnd = { day: newDay, time: newTime, user: newUser };
          updateSelection();
        }
      }
    });

    document.addEventListener('mouseup', (e) => {
      if (isDragging) {
        isDragging = false;
        document.querySelectorAll('.selecting').forEach(c => c.classList.remove('selecting'));
        if (dragStart && dragEnd) openModal(dragStart, dragEnd);
      }

      if (isResizing) {
        isResizing = false;
        resizingEvent = null;
        saveToLocalStorage();
      }

      if (isDraggingEvent && draggedEventIndex !== null) {
        // ë“œë¡­ íƒ€ê²Ÿ: schedule-cell ì¤‘ ë§ˆìš°ìŠ¤ ì•„ë˜ ê²ƒ
        const cells = document.querySelectorAll('.schedule-cell');
        let targetCell = null;

        cells.forEach(cell => {
          const rect = cell.getBoundingClientRect();
          if (e.clientX >= rect.left && e.clientX <= rect.right &&
              e.clientY >= rect.top && e.clientY <= rect.bottom) {
            targetCell = cell;
          }
        });

        if (targetCell) {
          const newDay = parseInt(targetCell.dataset.day);
          const newTime = parseInt(targetCell.dataset.time);
          const newUser = targetCell.dataset.user;

          const event = events[draggedEventIndex];
          const duration = event.endTime - event.startTime;

          event.day = newDay;
          event.startTime = newTime;
          event.endTime = Math.min(newTime + duration, times.length - 1);

          if (event.user !== 'common') event.user = newUser;

          // âœ… v8: ì»¤ìŠ¤í…€ í‘œì‹œ ì‹œê°„ì´ ì•„ë‹ˆë©´, ì´ë™ í›„ í‘œì‹œ ì‹œê°„ë„ ìŠ¬ë¡¯ ê¸°ì¤€ìœ¼ë¡œ ìë™ ê°±ì‹ 
          if (!event.customTime) {
            const d = defaultDisplayTimesFor(event);
            event.displayStart = d.start;
            event.displayEnd = d.end;
          }

          saveToLocalStorage();
          renderEvents();
        }

        isDraggingEvent = false;
        draggedEventIndex = null;
        document.querySelectorAll('.drop-target').forEach(c => c.classList.remove('drop-target'));
      }
    });

    document.addEventListener('mousemove', (e) => {
      // ë¦¬ì‚¬ì´ì¦ˆ
      if (isResizing && resizingEvent !== null) {
        const cells = document.querySelectorAll('.schedule-cell');
        let targetCell = null;

        cells.forEach(cell => {
          const rect = cell.getBoundingClientRect();
          if (e.clientX >= rect.left && e.clientX <= rect.right &&
              e.clientY >= rect.top && e.clientY <= rect.bottom) {
            targetCell = cell;
          }
        });

        if (targetCell) {
          const day = parseInt(targetCell.dataset.day);
          const time = parseInt(targetCell.dataset.time);
          const user = targetCell.dataset.user;
          const event = events[resizingEvent];

          if (day === event.day && time > event.startTime) {
            // ê³µí†µì´ë©´ ì–´ëŠ ìª½ ì¹¼ëŸ¼ì—ì„œ ë¦¬ì‚¬ì´ì¦ˆí•´ë„ OK
            if (event.user === 'common' || event.user === user) {
              event.endTime = time;
              if (!event.customTime) {
                const d = defaultDisplayTimesFor(event);
                event.displayStart = d.start;
                event.displayEnd = d.end;
              }
              renderEvents();
            }
          }
        }
      }

      // ë“œë˜ê·¸ ì´ë™ ì¤‘ drop-target í‘œì‹œ
      if (isDraggingEvent && draggedEventIndex !== null) {
        const cells = document.querySelectorAll('.schedule-cell');
        let targetCell = null;

        cells.forEach(cell => {
          const rect = cell.getBoundingClientRect();
          if (e.clientX >= rect.left && e.clientX <= rect.right &&
              e.clientY >= rect.top && e.clientY <= rect.bottom) {
            targetCell = cell;
          }
        });

        if (targetCell) {
          document.querySelectorAll('.schedule-cell').forEach(c => c.classList.remove('drop-target'));
          targetCell.classList.add('drop-target');
        }
      }
    });

    function updateSelection() {
      document.querySelectorAll('.selecting').forEach(c => c.classList.remove('selecting'));

      const minTime = Math.min(dragStart.time, dragEnd.time);
      const maxTime = Math.max(dragStart.time, dragEnd.time);

      for (let t = minTime; t <= maxTime; t++) {
        const cell = document.querySelector(
          `.schedule-cell[data-day="${dragStart.day}"][data-time="${t}"][data-user="${dragStart.user}"]`
        );
        if (cell) cell.classList.add('selecting');
      }
    }

    function openModal(start, end) {
      const minTime = Math.min(start.time, end.time);
      const maxTime = Math.max(start.time, end.time);

      currentEvent = {
        day: start.day,
        startTime: minTime,
        endTime: maxTime,
        user: start.user || selectedUser
      };

      selectedUser = currentEvent.user;

      document.getElementById('modalTitle').textContent = 'ìƒˆ ì¼ì •';
      document.getElementById('eventTitle').value = '';
      document.getElementById('eventDescription').value = '';

      // âœ… í‘œì‹œ ì‹œê°„ ê¸°ë³¸ê°’ ì„¸íŒ…(30ë¶„ ìŠ¬ë¡¯ ê¸°ì¤€)
      const d = defaultDisplayTimesFor(currentEvent);
      setDisplayInputs(d.start, d.end);


      document.querySelectorAll('.user-button').forEach(btn => btn.classList.remove('active'));
      document.querySelector(`.user-button.${selectedUser}`)?.classList.add('active');

      document.getElementById('eventModal').classList.add('active');
      document.getElementById('eventTitle').focus();
    }

    function selectUser(user) {
      selectedUser = user;
      document.querySelectorAll('.user-button').forEach(btn => btn.classList.remove('active'));
      document.querySelector(`.user-button.${user}`)?.classList.add('active');
    }

    function closeModal() {
      document.getElementById('eventModal').classList.remove('active');
      currentEvent = null;
    }

    function saveEvent() {
      const title = document.getElementById('eventTitle').value.trim();
      if (!title) { alert('ì¼ì • ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”'); return; }

      const description = document.getElementById('eventDescription').value.trim();

      // âœ… í‘œì‹œ ì‹œê°„ ì €ì¥(ë¶„ ë‹¨ìœ„ ê°€ëŠ¥) - ë¸”ë¡ì€ ê·¸ëŒ€ë¡œ
      const s = document.getElementById('displayStartTime')?.value || '';
      const e = document.getElementById('displayEndTime')?.value || '';

      const defaults = defaultDisplayTimesFor(currentEvent);
      const displayStart = s ? formatHHMM(s) : defaults.start;
      const displayEnd = e ? formatHHMM(e) : defaults.end;

      // ê¸°ë³¸ê°’ê³¼ ë‹¤ë¥´ë©´ customTime=true
      const customTime = (displayStart !== defaults.start) || (displayEnd !== defaults.end);

      if (currentEvent.index !== undefined) {
        events[currentEvent.index] = {
          ...events[currentEvent.index],
          title,
          description,
          user: selectedUser,
          displayStart,
          displayEnd,
          customTime
        };
      } else {
        events.push({
          ...currentEvent,
          title,
          description,
          user: selectedUser,
          displayStart,
          displayEnd,
          customTime
        });
      }

      saveToLocalStorage();
      renderEvents();
      closeModal();
    }

    function editEvent(index) {
      const event = events[index];
      currentEvent = { ...event, index };
      selectedUser = event.user || 'ahyun';

      document.getElementById('modalTitle').textContent = 'ì¼ì • ìˆ˜ì •';
      document.getElementById('eventTitle').value = event.title;
      document.getElementById('eventDescription').value = event.description || '';

      // âœ… í‘œì‹œ ì‹œê°„ ë¡œë“œ(ì—†ìœ¼ë©´ ê¸°ë³¸ê°’)
      const d = defaultDisplayTimesFor(event);
      setDisplayInputs(event.displayStart || d.start, event.displayEnd || d.end);


      document.querySelectorAll('.user-button').forEach(btn => btn.classList.remove('active'));
      document.querySelector(`.user-button.${selectedUser}`)?.classList.add('active');

      document.getElementById('eventModal').classList.add('active');
      document.getElementById('eventTitle').focus();
    }

    function deleteEvent(index) {
      if (confirm('ì´ ì¼ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        events.splice(index, 1);
        saveToLocalStorage();
        renderEvents();
      }
    }

    function clearAllEvents() {
      if (confirm('ëª¨ë“  ì¼ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        events = [];
        saveToLocalStorage();
        renderEvents();
      }
    }

    function saveToLocalStorage() {
      localStorage.setItem('weeklyEvents', JSON.stringify(events));
    }

    function showNotification(message) {
      const notification = document.createElement('div');
      notification.textContent = message;
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: #4CAF50;
        color: white;
        padding: 12px 24px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        z-index: 10000;
        font-size: 14px;
        animation: slideDown 0.3s ease-out;
      `;
      document.body.appendChild(notification);

      setTimeout(() => {
        notification.style.animation = 'slideUp 0.3s ease-out';
        setTimeout(() => document.body.removeChild(notification), 300);
      }, 3000);
    }

    function exportSchedule() {
      const exportData = {
        events: events,
        weekDates: weekDates || { monday: getNextMonday() }
      };

      const data = JSON.stringify(exportData, null, 2);
      const blob = new Blob([data], { type: 'application/json' });
      const url = URL.createObjectURL(blob);

      const a = document.createElement('a');
      a.href = url;

      const mondayStr = weekDates ? weekDates.monday : getNextMonday();
      const monday = new Date(mondayStr);
      const yy = String(monday.getFullYear()).slice(2);
      const mm = String(monday.getMonth() + 1).padStart(2, '0');
      const dd = String(monday.getDate()).padStart(2, '0');
      a.download = `weekly_schedule_${yy}${mm}${dd}.json`;

      a.click();
    }

    function importSchedule() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'application/json';
      input.onchange = (e) => {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = (event) => {
          try {
            const importedData = JSON.parse(event.target.result);

            if (importedData.events && Array.isArray(importedData.events)) {
              events = importedData.events;
              if (importedData.weekDates) {
                weekDates = importedData.weekDates;
                localStorage.setItem('weekDates', JSON.stringify(weekDates));
                loadSavedDates();
              }
            } else if (Array.isArray(importedData)) {
              events = importedData;
            } else {
              throw new Error('ì˜ëª»ëœ íŒŒì¼ í˜•ì‹');
            }

            saveToLocalStorage();
            renderEvents();
            alert('ì¼ì •ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤');
          } catch (err) {
            alert('íŒŒì¼ì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
          }
        };
        reader.readAsText(file);
      };
      input.click();
    }

    // Ctrl+V ë¶™ì—¬ë„£ê¸° (hoverëœ ì¹¸ ê¸°ì¤€)
    document.addEventListener('keydown', (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key === 'v' && copiedEvent) {
        e.preventDefault();

        const hoveredCell = document.querySelector('.schedule-cell:hover');
        if (hoveredCell) {
          const newDay = parseInt(hoveredCell.dataset.day);
          const newTime = parseInt(hoveredCell.dataset.time);
          const newUser = hoveredCell.dataset.user;

          const duration = copiedEvent.endTime - copiedEvent.startTime;

          events.push({
            ...copiedEvent,
            day: newDay,
            startTime: newTime,
            endTime: Math.min(newTime + duration, times.length - 1),
            user: (copiedEvent.user === 'common') ? 'common' : newUser
          });

          saveToLocalStorage();
          renderEvents();
          showNotification('ì¼ì •ì´ ë¶™ì—¬ë„£ê¸° ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }
      }
    });

    // ì¸ì‡„ ëª¨ë‹¬ ì´ˆê¸°í™” + ë Œë”
    initPrintModal();
    renderEvents();
  </script>
</body>
</html>
